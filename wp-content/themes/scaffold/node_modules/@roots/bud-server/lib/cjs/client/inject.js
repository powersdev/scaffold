"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.inject = void 0;
const bud_support_1 = require("@roots/bud-support");
const { isNull, isUndefined } = bud_support_1.lodash;
/**
 * Injects webpack entrypoints with HMR client scripts.
 *
 * Filters on `webpack.entry`
 *
 * @public
 */
const inject = async (instance, injection) => {
    instance.hooks.on('build.entry', entrypoints => {
        const invalidEntrypoints = !entrypoints ||
            isUndefined(entrypoints) ||
            isNull(entrypoints) ||
            !injection;
        if (invalidEntrypoints) {
            instance.warn(`${instance.name} entrypoints are malformed`, `skipping inject`);
            return entrypoints;
        }
        return Object.entries(entrypoints).reduce((entrypoints, [name, entry]) => {
            if (!entry)
                return entrypoints;
            entry.import = Array.from(new Set([
                ...injection.map(inject => inject(instance)),
                ...(entry.import ?? []),
            ]));
            return { ...entrypoints, [name]: entry };
        }, {});
    });
};
exports.inject = inject;
